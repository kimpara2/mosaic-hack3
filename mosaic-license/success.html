<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>ご登録ありがとうございます</title>
  </head>
  <body>
    <h1>ご登録ありがとうございます！</h1>
    <div id="status">準備中...</div>

    <div id="result" style="display:none;">
      <p><a id="dl" href="#" target="_blank" rel="noopener">ダウンロードページへ</a></p>

      <p>ライセンスキー：</p>
      <pre id="license" style="user-select:all;"></pre>
      <button id="copy">コピー</button>
      <button id="save">ライセンスファイルを保存</button>

      <hr />
      <small>管理コード（控えてください）：<code id="sid"></code></small>
      <p>※このページは安全のため再表示できません。キーは必ず控えてください。</p>
    </div>

    <pre id="debug" style="white-space:pre-wrap; font-size:12px; opacity:.7;"></pre>

    <script>
      const $ = (id) => document.getElementById(id);
      const setStatus = (msg) => { $('status').textContent = msg; };
      const setDebug = (msg) => { $('debug').textContent = msg; };

      async function fetchJsonWithTimeout(url, options = {}, ms = 15000) {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), ms);
        try {
          const res = await fetch(url, { ...options, signal: ctrl.signal });
          const text = await res.text(); // まず text で受ける（JSONじゃない時に落ちない）
          let data = null;
          try { data = text ? JSON.parse(text) : null; } catch (_) { /* JSONじゃない */ }
          return { res, text, data };
        } finally {
          clearTimeout(t);
        }
      }

      (async () => {
        try {
          const q = new URLSearchParams(location.search);
          const sessionId = q.get("session_id");
          if (!sessionId) { setStatus("セッションIDがありません"); return; }

          $('sid').textContent = sessionId;

          const apiUrl = "/api/issue-license";
          setDebug(`session_id=${sessionId}\nPOST ${apiUrl}\n`);

          const { res, text, data } = await fetchJsonWithTimeout(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sessionId })
          }, 20000);

          setDebug((prev => prev + `\nstatus=${res.status}\ncontent-type=${res.headers.get("content-type")}\nbody=${text.slice(0, 500)}\n`)($('debug').textContent));

          if (!res.ok) {
            // JSONで message が来る想定
            const msg = (data && (data.message || data.error)) ? (data.message || data.error)
              : `発行に失敗しました（HTTP ${res.status}）。`;
            setStatus(msg);
            return;
          }

          if (!data) {
            setStatus("サーバー応答がJSONではありません。");
            return;
          }

          // 期待フィールド
          const downloadUrl = data.downloadUrl || data.download_url;
          const licenseKey = data.licenseKey || data.license_key || data.plain_key;

          if (!downloadUrl || !licenseKey) {
            setStatus("応答の形式が想定と違います（downloadUrl / licenseKey が無い）。");
            return;
          }

          // 表示
          $('dl').href = downloadUrl;
          $('license').textContent = licenseKey;

          // UI切り替え
          $('status').style.display = "none";
          $('result').style.display = "block";

          // コピー（iOSはユーザー操作が必要）
          $('copy').onclick = async () => {
            await navigator.clipboard.writeText(licenseKey);
            alert("コピーしました");
          };

          // .lic保存
          $('save').onclick = () => {
            const blob = new Blob([`LICENSE_KEY=${licenseKey}\n`], { type: "text/plain" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "mosaic_tool.lic";
            a.click();
            URL.revokeObjectURL(a.href);
          };

        } catch (e) {
          setStatus("通信または処理でエラーになりました。");
          setDebug($('debug').textContent + `\nERROR: ${e?.message || e}\n`);
        }
      })();
    </script>
  </body>
</html>